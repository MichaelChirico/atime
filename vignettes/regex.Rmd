<!--
%\VignetteEngine{knitr::knitr}
%\VignetteIndexEntry{Regular expression examples}
-->

# Regular expression examples

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r}
max.N <- 20
(backtrackers <- c(
  if(requireNamespace("stringi"))atime::atime_grid(
    ICU=stringi::stri_match(subject, regex=pattern)),
  atime::atime_grid(
    PCRE=regexpr(pattern, subject, perl=TRUE),
    TRE=regexpr(pattern, subject, perl=FALSE))))
atime.list <- atime::atime(
  N=1:max.N,
  setup={
    subject <- paste(rep("a", N), collapse="")
    pattern <- paste(rep(c("(a)?", "\\1"), each=N), collapse="")
  },
  expr.list=backtrackers)
plot(atime.list)

if(require(ggplot2)){
  gg <- ggplot()+
    geom_ribbon(aes(
      N, ymin=min, ymax=max, fill=expr.name),
      data=atime.list$meas,
      alpha=0.5)+
    geom_line(aes(
      N, median, color=expr.name),
      data=atime.list$meas)+
    scale_x_log10()+
    scale_y_log10("seconds (median line, min/max band)")
  if(require("directlabels")){
    direct.label(gg, "top.polygons")
  }else{
    gg
  }
}
```

The plots above show that ICU/PCRE/TRE are all exponential in N
(subject/pattern size) when the pattern contains backreferences.

```{r}
expr.list <- c(
  if(requireNamespace("re2"))atime::atime_grid(
    RE2=re2::re2_match(subject, pattern)),
  backtrackers)
atime.list <- atime::atime(
  N=1:25,
  setup={
    subject <- paste(rep("a", N), collapse="")
    pattern <- paste(rep(c("a?", "a"), each=N), collapse="")
  },
  expr.list=expr.list,
  times=3)
plot(atime.list)

best.list <- atime::references_best(atime.list)
if(require(ggplot2)){
  gg <- ggplot()+
    geom_ribbon(aes(
      N, ymin=min, ymax=max, fill=expr.name),
      data=best.list$meas[unit=="seconds"],
      alpha=0.5)+
    geom_line(aes(
      N, empirical, color=expr.name),
      data=best.list$meas)+
    facet_grid(unit ~ ., scales="free")+
    theme(legend.position="none")+
    scale_x_log10()+
    scale_y_log10("median line, min/max band")
  if(require("directlabels")){
    gg+
      geom_dl(aes(
        N, empirical, color=expr.name, label=expr.class),
        method="right.polygons",
        data=best.list$meas)+
      coord_cartesian(xlim=c(1,30))
  }else{
    gg
  }
}
```

The plots above show that ICU/PCRE are exponential time whereas
RE2/TRE are polynomial time. Exercise for the reader: modify the above
code to use the `seconds.limit` argument so that you can see what
happens to ICU/PCRE for larger N (hint: you should see a difference at
larger sizes).

## `atime_grid` to compare different engines

In the `nc` package there is an `engine` argument which controls which
C regex library is used:

```{r}
expr.list <- atime::atime_grid(
  list(ENGINE=c(
    if(requireNamespace("re2"))"RE2",
    "PCRE",
    if(requireNamespace("stringi"))"ICU")),
  nc=nc::capture_first_vec(subject, pattern, engine=ENGINE))
atime.list <- atime::atime(
  N=1:25,
  setup={
    rep.collapse <- function(chr)paste(rep(chr, N), collapse="")
    subject <- rep.collapse("a")
    pattern <- list(maybe=rep.collapse("a?"), rep.collapse("a"))
  },
  expr.list=expr.list)
plot(atime.list)
```
