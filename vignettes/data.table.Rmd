<!--
%\VignetteEngine{knitr::knitr}
%\VignetteIndexEntry{Comparing git versions of data.table}
-->

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = FALSE
)
```

In this vignette we show you how to compare asymptotic timings of an R
expression which uses different versions of the `data.table` package,
which we clone from github using the code below,

```{r}
if(FALSE){
  atime::atime_versions_remove("data.table")
}
pkg.path <- tempfile()
dir.create(pkg.path)
git2r::clone("https://github.com/Rdatatable/data.table", pkg.path)
pkg.edit.fun <- function(old.Package, new.Package, sha, new.pkg.path){
  pkg_find_replace <- function(glob, FIND, REPLACE){
    atime::glob_find_replace(file.path(new.pkg.path, glob), FIND, REPLACE)
  }
  Package_regex <- gsub(".", "_?", old.Package, fixed=TRUE)
  R_init_pkg <- paste0("R_init_", Package_regex)
  Package_ <- gsub(".", "_", old.Package, fixed=TRUE)
  new.Package_ <- paste0(Package_, "_", sha)
  pkg_find_replace(
    "DESCRIPTION", 
    paste0("Package:\\s+", old.Package),
    paste("Package:", new.Package))
  pkg_find_replace(
    file.path("src","Makevars.*in"),
    Package_regex,
    new.Package_)
  pkg_find_replace(
    file.path("R", "onLoad.R"),
    Package_regex,
    new.Package_)
  pkg_find_replace(
    file.path("R", "cedta.R"),
    'nsname=="data.table"',
    'nsname==packageName()')
  pkg_find_replace(
    file.path("R", "onLoad.R"),
    sprintf('packageVersion\\("%s"\\)', old.Package),
    sprintf('packageVersion\\("%s"\\)', new.Package))
  pkg_find_replace(
    file.path("src", "init.c"),
    R_init_pkg,
    paste0("R_init_", new.Package_))
  pkg_find_replace(
    "NAMESPACE",
    sprintf('useDynLib\\("?%s"?', Package_regex),
    paste0('useDynLib(', new.Package_))
}
```

## no aggregation, no missing cells in result

```{r}
atime.list <- atime::atime_versions(
  pkg.path=pkg.path,
  pkg.edit.fun=pkg.edit.fun,
  N = 10^seq(1, 7),
  setup={
    divisor=5
    x=seq(0,N-1)
    i=x %/% divisor
    j=x %% divisor
    DT=data.table::data.table(x,i,j)
  },
  expr={
    data.table::dcast(DT, i ~ j, value.var="x")
  },
  results = FALSE,
  verbose = TRUE,
  seconds.limit=1,
  times=10,
  INTEGER.before.loop="6a93cb1218c94c650dfe3d1ac5d572c9469c5c91",
  INTEGER.in.loop="50553069b636b15cdcf15741e7e00de999b2a36a",
  master.1.14.7="cb8aeff9453acec878e5ab8515cda0d302c943eb",
  release.1.14.6="3e5d038ee4a800104b665ac39392ceed46b1189d")
best.list <- atime::references_best(atime.list)
if(require(ggplot2)){
  hline.df <- with(atime.list, data.frame(seconds.limit, unit="seconds"))
  gg <- ggplot()+
    theme_bw()+
    facet_grid(unit ~ ., scales="free")+
    geom_hline(aes(
      yintercept=seconds.limit),
      color="grey",
      data=hline.df)+
    geom_line(aes(
      N, empirical, color=expr.name),
      data=best.list$meas)+
    geom_ribbon(aes(
      N, ymin=min, ymax=max, fill=expr.name),
      data=best.list$meas[unit=="seconds"],
      alpha=0.5)+
    scale_x_log10()+
    scale_y_log10("median line, min/max band")
  gg.out <- if(require(directlabels)){
    gg+
      directlabels::geom_dl(aes(
        N, empirical, color=expr.name, label=expr.name),
        method="right.polygons",
        data=best.list$meas)+
      theme(legend.position="none")+
      coord_cartesian(xlim=c(1e3,1e8))
  }else{
    gg
  }
  png("~/R/pr5549-no-agg-no-missing.png", width=7, height=7, units="in", res=100)
  print(gg.out)
  dev.off()
}
```

## no aggregation, 50\% missing cells in result

```{r}
atime.list <- atime::atime_versions(
  pkg.path=pkg.path,
  pkg.edit.fun=pkg.edit.fun,
  N = 10^seq(1, 7),
  setup={
    divisor=5
    x=seq(0,N-1)
    i=x %/% divisor
    j=x %% divisor
    set.seed(1)
    DT=data.table::data.table(x,i,j)[sample(.N, .N/2)]
  },
  expr={
    data.table::dcast(DT, i ~ j, value.var="x")
  },
  results = FALSE,
  verbose = TRUE,
  seconds.limit=1,
  times=10,
  INTEGER.before.loop="6a93cb1218c94c650dfe3d1ac5d572c9469c5c91",
  INTEGER.in.loop="50553069b636b15cdcf15741e7e00de999b2a36a",
  master.1.14.7="cb8aeff9453acec878e5ab8515cda0d302c943eb",
  release.1.14.6="3e5d038ee4a800104b665ac39392ceed46b1189d")
best.list <- atime::references_best(atime.list)
if(require(ggplot2)){
  hline.df <- with(atime.list, data.frame(seconds.limit, unit="seconds"))
  gg <- ggplot()+
    theme_bw()+
    facet_grid(unit ~ ., scales="free")+
    geom_hline(aes(
      yintercept=seconds.limit),
      color="grey",
      data=hline.df)+
    geom_line(aes(
      N, empirical, color=expr.name),
      data=best.list$meas)+
    geom_ribbon(aes(
      N, ymin=min, ymax=max, fill=expr.name),
      data=best.list$meas[unit=="seconds"],
      alpha=0.5)+
    scale_x_log10()+
    scale_y_log10("median line, min/max band")
  gg.out <- if(require(directlabels)){
    gg+
      directlabels::geom_dl(aes(
        N, empirical, color=expr.name, label=expr.name),
        method="right.polygons",
        data=best.list$meas)+
      theme(legend.position="none")+
      coord_cartesian(xlim=c(1e3,1e8))
  }else{
    gg
  }
  png("~/R/pr5549-no-agg-half-missing.png", width=7, height=7, units="in", res=100)
  print(gg.out)
  dev.off()
}
```

## min aggregation

```{r}
atime.list <- atime::atime_versions(
  pkg.path=pkg.path,
  pkg.edit.fun=pkg.edit.fun,
  N = 10^seq(1, 7),
  setup={
    divisor=5
    x=seq(0,N-1)
    i=x %/% divisor
    grp = floor(i/2)
    j=x %% divisor
    set.seed(1)
    DT=data.table::data.table(x,i,j,grp)
  },
  expr={
    data.table::dcast(DT, grp ~ j, list(min, length), value.var="x")
  },
  results = FALSE,
  verbose = TRUE,
  seconds.limit=1,
  times=10,
  INTEGER.before.loop="6a93cb1218c94c650dfe3d1ac5d572c9469c5c91",
  INTEGER.in.loop="50553069b636b15cdcf15741e7e00de999b2a36a",
  master.1.14.7="cb8aeff9453acec878e5ab8515cda0d302c943eb",
  release.1.14.6="3e5d038ee4a800104b665ac39392ceed46b1189d")
best.list <- atime::references_best(atime.list)
if(require(ggplot2)){
  hline.df <- with(atime.list, data.frame(seconds.limit, unit="seconds"))
  gg <- ggplot()+
    theme_bw()+
    facet_grid(unit ~ ., scales="free")+
    geom_hline(aes(
      yintercept=seconds.limit),
      color="grey",
      data=hline.df)+
    geom_line(aes(
      N, empirical, color=expr.name),
      data=best.list$meas)+
    geom_ribbon(aes(
      N, ymin=min, ymax=max, fill=expr.name),
      data=best.list$meas[unit=="seconds"],
      alpha=0.5)+
    scale_x_log10()+
    scale_y_log10("median line, min/max band")
  gg.out <- if(require(directlabels)){
    gg+
      directlabels::geom_dl(aes(
        N, empirical, color=expr.name, label=expr.name),
        method="right.polygons",
        data=best.list$meas)+
      theme(legend.position="none")+
      coord_cartesian(xlim=c(1e3,1e8))
  }else{
    gg
  }
  png("~/R/pr5549-min-agg.png", width=7, height=7, units="in", res=100)
  print(gg.out)
  dev.off()
}
```

